---
title: "A Deep Dive into Medicare Data"
author: "Zoshua Colah, Vanessa Hsu, Eui Yul Song, Katherine Lui"
date: "5/24/2018"
output: html_document
---

```{r Part One:Summary, echo=FALSE, message=FALSE, warning=FALSE}

#Loading Libraries
library(devtools)
library (dplyr)
library (knitr)
library (plotly)
```

# Introduction

The Medicare program of the United States, is a federal insurance program to help mitigate the financial burden healthcare places on people of ages 65 years and older, younger people with disabilities, and people with end-stage renal diseases. This project explores the most expensive inpatient procedures in the United States to get a better understanding of how these costs vary by state, year and more. This will provide Medicare beneficiaries with information on the varying costs of certain procedures. It will also give an overview of where much of the money allotted to Medicare is being used and how that amount is changing over the years.

# Data Sources

## Inpatient Prospective Payment System (IPPS) Provider Summary for Diagnosis-Related Groups (DRG) - 2011 to 2015

**The Centers for Medicare & Medicaid Services (CMS)** has prepared a public data set for the *years 2011 to 2015*, the Provider Utilization and Payment Data Inpatient Public Use File (herein referred to as “Inpatient PUF”), with information on services and procedures provided to Medicare beneficiaries by hospital facilities. The Inpatient PUF contains hospital-specific charges for the **more than 3,000 U.S. hospitals** that receive Medicare Inpatient Prospective Payment System (IPPS) payments paid under Medicare based on a rate per discharge using the Medicare Severity Diagnosis Related Group (MS-DRG). The Inpatient PUF is available for fiscal years 2011 through 2015 and reflect 100% final-action (i.e., all claim adjustmentshave been resolved) IPPS discharges for the Medicare fee-for-service (FFS) population. Beginning with FY2014 data, all MS-DRG discharges are reported in the Inpatient PUF. Prior years of the Inpatient PUF (FY2011 through FY2013) are limited to the top 100 most frequently billed discharges.

*Link to Datasets* 

* Top 100 DRGs for FY 2011: 
* Top 100 DRGs for FY 2012: 
* Top 100 DRGs for FY 2013: 
* All DRGs for FY 2014: 
* All DRGs for FY 2015: 

**Key Facts about the dataset:** 

* Represent more than 7 million discharges or 60 percent of total Medicare IPPS discharges
* More than 3,000  U.S. hospitals (that received Medicare) represented 

## DRG Category List

Dr.Jihjane Li, an independant doctor, provided us with a dataset which categorized the Diagnostic Related Groups by the body system they impact and the medical department which would be responsible for it.

*Link to Dataset:* 

# DRG DataSet for 2011 to 2015

For our investigation, we created a parent dataset, which would contain all the DRG discharge and medicare data for the years 2011 - 2015.

To make this dataset we did the following steps:

* Data Wrangling: We binded the datasets for all the 5 years and joined them to DRG Category dataset we got from Dr.Jihjane Li.
* Data Cleaning: We normalized the DRG name for each DRG number. This was because some of the DRGs Numbers had got small updates to their names such as a "+" in place of a ">". 
* Data Exploration: Through our data exploration we were able to identify that we have data for all 5 years for only *91 DRGs*.

**Link to Dataset:**

## Data Set Variables

* **DRG Definition:** The code and description identifying the MS-DRG. MS-DRGs are a classification system that groups similar clinical conditions (diagnoses) and the procedures furnished by the hospital during the stay.
* **Provider Id:** The CMS Certification Number (CCN) assigned to the Medicare certified hospital facility.
* **Provider Name:** The name of the provider.
* **Provider Street Address:** The provider’s street address.
* **Provider City:** The city where the provider is located.
* **Provider State:** The state where the provider is located.
* **Provider Zip Code:** The provider’s zip code.
* **Provider HRR:** The Hospital Referral Region (HRR) where the provider is located.
* **Total Discharges:** The number of discharges billed by the provider for inpatient hospital services.
* **Average Covered Charges:** The provider's average charge for services covered by Medicare for all discharges in the MS-DRG. These will vary from hospital to hospital because of differences in hospital charge structures.
* **Average Total Payments:** The average total payments to all providers for the MS-DRG including the MSDRG amount, teaching, disproportionate share, capital, and outlier payments for all cases.
* **Average Medicare Payments:** The average amount that Medicare pays to the provider for Medicare's share of the MS-DRG. Average Medicare payment amounts include the MS-DRG amount, teaching, disproportionate share, capital, and outlier payments for all cases.
* **Body System:** The human body system which is impacted with respect to the DRG.
* **Medical Department:** the Medical Department responsible for the DRG

## Overview Datasets

In addition to the parent dataset, we created overview datasets to give a concise overview about the following statistics for each DRG, medical department, and human body system: 

* Total Discharges 
* Average Medicare Payments
* Average Covered Charges 
* Average Total Payments 

In addition to these overview datasets, we created datasets for the top 5, 10, 20, 50 and 100 DRGs for each statistic. 

Link to Overview Datasets:

--------------------------------------------------------

# Overview of Medicare Beneficiaries for 2011 - 2015

## Total Discharge Statistics
Lorem Ipsum is simply dummy text of the printing and typesetting industry. Lorem Ipsum has been the industry's standard dummy text ever since the 1500s, when an unknown printer took a galley of type and scrambled it to make a type specimen book. It has survived not only five centuries, but also the leap into electronic typesetting, remaining essentially unchanged. It was popularised in the 1960s with the release of Letraset sheets containing Lorem Ipsum passages, and more recently with desktop publishing software like Aldus PageMaker including versions of Lorem Ipsum.

```{r Part Two:Total Discharge Statistics, results = 'asis', echo=FALSE, message=FALSE, warning=FALSE}

##############################################################################################
# Discharge Data                                                                             #
##############################################################################################

top_10_discharges <- read.csv("../../Data/Prepared/top_10_discharges.csv") 
top_10_discharges <- top_10_discharges %>% arrange(total_discharges)
colnames(top_10_discharges) <- c("drg","2011", "2012", "2013", "2014", "2015", "total")
f <- list( family = "Open Sans, Sans Serif, monospace", size = 10, color = "#7f7f7f")

##############################################################################################
# Discharge Bar Chart Viz                                                                    #
##############################################################################################

# Horizontal Bar Chart

y <- list( title = "", titlefont = f)
x <- list( title = "Number of Discharges", titlefont = f)
t <- list(
  family = "Arial",
  size = 9,
  color = 'Black')


discharges_h_bar <- plot_ly(top_10_discharges,
                            x = ~`2011`,
                            y = ~reorder(drg,total), 
                            type = 'bar', 
                            orientation = 'h',
                            name = '2011', marker = list(color = '#25CCF7')) %>% 
                    add_trace(x = ~`2012`, name = "2012", marker = list(color = '#1B9CFC')) %>%
                    add_trace(x = ~`2013`, name = "2013", marker = list(color = '#B33771')) %>% 
                    add_trace(x = ~`2014`, name = "2014", marker = list(color = '#3B3B98')) %>% 
                    add_trace(x = ~`2015`, name = "2015", marker = list(color = '#182C61')) %>%
                    layout(title = 'DRGs with Most Discharges for 2011-15 (Top 10)',
                            font = t,
                            xaxis = x, 
                            yaxis = y,
                            barmode = 'stack',
                            margin = list(l = 420, b = 100, pad = 4), 
                            yaxis = list(tickangle = 90),
                            legend = list(orientation = 'h', 
                            title = 'Legend',
                            font = list( family = "sans-serif",
                            size = 8,
                            color = "#000"),
                            bgcolor = "FFFFFF",
                            bordercolor = "#0a3d62",
                            borderwidth = 0.5)) %>%
                    add_annotations(xref = 'x1', yref = 'y',
                    x = ~total + 170000,
                    text =  ~paste(total, '<br>discharges'),
                    font = list(family = 'Arial', size = 10, color = 'rgb(150, 171, 234)'),
                    showarrow = FALSE)    

##############################################################################################
# Top 10 DRG Discharges Cost Break Down Bar Chart                                            #
##############################################################################################
cost_breakdown <- read.csv("../../Data/Prepared/top_10_discharge_costs.csv")
cost_breakdown <- cost_breakdown %>% arrange(-discharges)

t <- list(
  family = "sans-serif",
  size = 10,
  color = 'Black')

cost_breakdown_chart <- plot_ly(cost_breakdown, 
                                y = ~reorder(drg, discharges), 
                                x = ~avg_covered_charge, 
                                type = 'bar', 
                                name = 'Average Covered Charges', 
                                marker = list(color = '#31A4DB'),
                                orientation = "h") %>%
                        add_trace(x = ~avg_total_payment, name = 'Average Total Payments', marker = list(color = '#9EC43C')) %>%
                        add_trace(x = ~avg_medicare_payment, name = 'Average Medicare Charges', marker = list(color = 'F6AB3B')) %>% 
                        layout(title = "Cost Breakdown for the DRGs with Most Discharges - Top 10",
                               font = t, 
                               xaxis = list(title = 'Cost ($)'),
                               yaxis = list(title = ''), 
                               barmode = 'group', margin = list(l = 420,t = 50, pad = 4), 
                               xaxis = list(tickangle = 45),
                               legend = list(orientation = 'h', 
                                             title = 'Legend',
                                             font = list( family = "sans-serif",
                                                          size = 10,
                                                          color = "#000"),
                                                          bgcolor = "FFFFFF",
                                                          bordercolor = "#0a3d62",
                                                          borderwidth = 0.5)) 

##############################################################################################
# Discharge Statistics for Human Body System Affected                                        #
##############################################################################################

# need to add in data visualization 

##############################################################################################
# Discharge Table                                                                            #
##############################################################################################
# Renaming columns for better presentation of the table
colnames(top_10_discharges) <- c("DRG","2011", "2012", "2013", "2014", "2015", "Total Discharges")
#Transposing the dataframe for better presenation of the data in the HTML document
#Commenting out for the time being
#kable(top_10_discharges, digits = 2,  caption = "Top 10 Diagnostic Related Groups with the Most Discharges (2011-15)")
```

-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

`r discharges_h_bar`

-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

`r cost_breakdown_chart `

## Average Medicare Payment Statistics
Lorem Ipsum is simply dummy text of the printing and typesetting industry. Lorem Ipsum has been the industry's standard dummy text ever since the 1500s, when an unknown printer took a galley of type and scrambled it to make a type specimen book. It has survived not only five centuries, but also the leap into electronic typesetting, remaining essentially unchanged. It was popularised in the 1960s with the release of Letraset sheets containing Lorem Ipsum passages, and more recently with desktop publishing software like Aldus PageMaker including versions of Lorem Ipsum.

```{r Part Three: Average Medicare Payment Statistics, results = 'asis', echo=FALSE, message=FALSE, warning=FALSE}

##############################################################################################
# Data 
##############################################################################################

f <- list( family = "Open Sans, Sans Serif, monospace", size = 10, color = "#7f7f7f")
top_10_medicare <- read.csv("../../Data/Prepared/top_10_avg_medicare_payments.csv")
top_10_medicare <- top_10_medicare%>% arrange(avg_medicare_payments)
colnames(top_10_medicare) <- c("drg","2011", "2012", "2013", "2014", "2015", "avg")

# Vertical Bar Chart
x <- list( title = "Average Medicare Payments($)", titlefont = f)
y <- list( title = "", titlefont = f)

medicare_payments_bar <- plot_ly(top_10_medicare,
                              y = ~reorder(drg, avg),
                              x = ~`avg` , 
                              type = 'bar', 
                              name = 'Average Medicare Payments', 
                              orientation = "h",
                              marker = list(color = '#079992')) %>% 
  layout(title = 'Top 10 DRGs with Highest Average Medicare Payments',
         xaxis = x, 
         yaxis = y,
         font = t,
         margin = list( l = 430, pad = 4), 
         xaxis = list(tickangle = 45)) %>%
  add_annotations(xref = 'x1', yref = 'y',
                  x = ~avg + 5500,
                  text = ~paste("$",round(avg,2)),
                  font = list(family = 'Arial', size = 10, color = 'rgb(150, 171, 234)'),
                  showarrow = FALSE)                  
```

`r medicare_payments_bar`

## Average Covered Charge Statistics
Lorem Ipsum is simply dummy text of the printing and typesetting industry. Lorem Ipsum has been the industry's standard dummy text ever since the 1500s, when an unknown printer took a galley of type and scrambled it to make a type specimen book. It has survived not only five centuries, but also the leap into electronic typesetting, remaining essentially unchanged. It was popularised in the 1960s with the release of Letraset sheets containing Lorem Ipsum passages, and more recently with desktop publishing software like Aldus PageMaker including versions of Lorem Ipsum.

```{r Part Four: Average Covered Charge Statistics, results = 'asis', echo=FALSE, message=FALSE, warning=FALSE}

##############################################################################################
# Data
##############################################################################################

f <- list( family = "Open Sans, Sans Serif, monospace", size = 10, color = "#7f7f7f")
top_10_covered <- read.csv("../../Data/Prepared/top_10_avg_covered_charges.csv")
top_10_covered <- top_10_covered%>% arrange(avg_covered_charges)
colnames(top_10_covered) <- c("drg","2011", "2012", "2013", "2014", "2015", "avg")


# Horizontal Bar Chart

y <- list( title = "", titlefont = f)
x <- list( title = "Number of Discharges", titlefont = f)

covered_charges_h_bar <- plot_ly(top_10_covered,
                               y = ~reorder(drg, avg),
                               x = ~`avg` , 
                               type = 'bar', 
                               name = 'Average Covered Charges',
                               orientation = "h",
                               marker = list(color = '#079992')) %>% 
                        layout(title = 'Top 10 DRGs with Highest Average Covered Charges',
                               xaxis = x, 
                               yaxis = y,
                               font = t,
                               margin = list( l = 430, pad = 4),
                               xaxis = list(tickangle = 45)) %>%
                        add_annotations(xref = 'x1', yref = 'y',
                                        x = ~avg + 18000,
                                        text = ~paste("$",round(avg,2)),
                                        font = list(family = 'Arial', size = 12, color = 'rgb(150, 171, 234)'),
                                        showarrow = FALSE)   
```

`r covered_charges_h_bar`


# Average Total Payment Statistics

Lorem Ipsum is simply dummy text of the printing and typesetting industry. Lorem Ipsum has been the industry's standard dummy text ever since the 1500s, when an unknown printer took a galley of type and scrambled it to make a type specimen book. It has survived not only five centuries, but also the leap into electronic typesetting, remaining essentially unchanged. It was popularised in the 1960s with the release of Letraset sheets containing Lorem Ipsum passages, and more recently with desktop publishing software like Aldus PageMaker including versions of Lorem Ipsum.

```{r Part Five: Average Total Payment Statistics, results = 'asis', echo=FALSE, message=FALSE, warning=FALSE}

##############################################################################################
# Data - Average Total Payments                                                              #
##############################################################################################
f <- list( family = "Open Sans, Sans Serif, monospace", size = 18, color = "#7f7f7f")
top_10_payments <- read.csv("../../Data/Prepared/top_10_avg_total_payments.csv")
top_10_payments <- top_10_payments%>% arrange(avg_total_payments)
colnames(top_10_payments) <- c("drg","2011", "2012", "2013", "2014", "2015", "avg")


##############################################################################################
# Bar Chart Viz for Average Total Payment Statistics
# Horizontal Bar Chart
y <- list( title = "", titlefont = f)
x <- list( title = "Number of Discharges", titlefont = f)
total_payments_h_bar <- plot_ly(top_10_payments,
                                 y = ~reorder(drg, avg),
                                 x = ~`avg` , 
                                 type = 'bar', 
                                 name = 'Average Total Payments',
                                 orientation = "h",
                                 marker = list(color = '#079992')) %>% 
  layout(title = 'Top 10 DRGs with Highest Average Total Payments',
         xaxis = x, 
         yaxis = y,
         margin = list(l = 500, pad = 4), 
         xaxis = list(tickangle = 45)) %>%
  add_annotations(xref = 'x1', yref = 'y',
                  x = ~avg + 10000,
                  text = ~paste("$",round(avg,2)),
                  font = list(family = 'Arial', size = 12, color = 'rgb(150, 171, 234)'),
                  showarrow = FALSE) 


```

`r total_payments_h_bar`

## Human Body System Statistics
Lorem Ipsum is simply dummy text of the printing and typesetting industry. Lorem Ipsum has been the industry's standard dummy text ever since the 1500s, when an unknown printer took a galley of type and scrambled it to make a type specimen book. It has survived not only five centuries, but also the leap into electronic typesetting, remaining essentially unchanged. It was popularised in the 1960s with the release of Letraset sheets containing Lorem Ipsum passages, and more recently with desktop publishing software like Aldus PageMaker including versions of Lorem Ipsum.