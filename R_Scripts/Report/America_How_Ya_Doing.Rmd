---
title: "A Deep Dive into Medicare Data"
author: "Zoshua Colah, Vanessa Hsu, Eui Yul Song, Katherine Lui"
date: "5/24/2018"
output: html_document
---
  
```{r Part One:Summary, echo=FALSE, message=FALSE, warning=FALSE}

# Loading Libraries
library(devtools)
library (dplyr)
library (knitr)
library (plotly)

# Main Dataset
# Do not need at the moment
```

# Introduction

The Medicare program of the United States, is a federal insurance program to help mitigate the financial burden healthcare places on people of ages 65 years and older, younger people with disabilities, and people with end-stage renal diseases. Each medicare covered inpatient procedure and service is classfied under a *DRG (Diagnostic Related Group) Number and Label* which is used to help classify medicare charges. This project explores DRG records for the years 2011 - 2015 and produces different visualizations and insights. 

We have explored the most expensive inpatient procedures in the United States to get a better understanding of how these costs vary by state, year and more. This will provide Medicare beneficiaries with information on the varying costs of certain procedures. It will also give an overview of where much of the money allotted to Medicare is being used and how that amount is changing over the years.

# Data Sources

## Inpatient Prospective Payment System (IPPS) Provider Summary for Diagnosis-Related Groups (DRG) - 2011 to 2015

**The Centers for Medicare & Medicaid Services (CMS)** has prepared a public data set for the *years 2011 to 2015*, the Provider Utilization and Payment Data Inpatient Public Use File (herein referred to as “Inpatient PUF”), with information on services and procedures provided to Medicare beneficiaries by hospital facilities. The Inpatient PUF contains hospital-specific charges for the **more than 3,000 U.S. hospitals** that receive Medicare Inpatient Prospective Payment System (IPPS) payments paid under Medicare based on a rate per discharge using the Medicare Severity Diagnosis Related Group (MS-DRG). The Inpatient PUF is available for fiscal years 2011 through 2015 and reflect 100% final-action (i.e., all claim adjustmentshave been resolved) IPPS discharges for the Medicare fee-for-service (FFS) population. Beginning with FY2014 data, all MS-DRG discharges are reported in the Inpatient PUF. Prior years of the Inpatient PUF (FY2011 through FY2013) are limited to the top 100 most frequently billed discharges.

*Link to Datasets* 
  
* Top 100 DRGs for FY 2011: 
* Top 100 DRGs for FY 2012: 
* Top 100 DRGs for FY 2013: 
* All DRGs for FY 2014: 
* All DRGs for FY 2015: 
  
**Key Facts about the dataset:** 
  
* Represent more than 7 million discharges or 60 percent of total Medicare IPPS discharges
* More than 3,000  U.S. hospitals (that received Medicare) represented 

## DRG Category List

Dr.Jihjane Li, an independant doctor, provided us with a dataset which categorized the Diagnostic Related Groups by the body system they impact and the medical department which would be responsible for it.

*Link to Dataset:* 
  
# DRG DataSet for 2011 to 2015
  
For our investigation, we created a parent dataset, which would contain all the DRG discharge and medicare data for the years 2011 - 2015.

To make this dataset we did the following steps:
  
* Data Wrangling: We binded the datasets for all the 5 years and joined them to DRG Category dataset we got from Dr.Jihjane Li.
* Data Cleaning: We normalized the DRG name for each DRG number. This was because some of the DRGs Numbers had got small updates to their names such as a "+" in place of a ">". 
* Data Exploration: Through our data exploration we were able to identify that we have data for all 5 years for only *91 DRGs*.

**Link to Dataset:**
  
## Data Set Variables
  
* **DRG Definition:** The code and description identifying the MS-DRG. MS-DRGs are a classification system that groups similar clinical conditions (diagnoses) and the procedures furnished by the hospital during the stay.
* **Provider Id:** The CMS Certification Number (CCN) assigned to the Medicare certified hospital facility.
* **Provider Name:** The name of the provider.
* **Provider Street Address:** The provider’s street address.
* **Provider City:** The city where the provider is located.
* **Provider State:** The state where the provider is located.
* **Provider Zip Code:** The provider’s zip code.
* **Provider HRR:** The Hospital Referral Region (HRR) where the provider is located.
* **Total Discharges:** The number of discharges billed by the provider for inpatient hospital services.
* **Average Covered Charges:** The provider's average charge for services covered by Medicare for all discharges in the MS-DRG. These will vary from hospital to hospital because of differences in hospital charge structures.
* **Average Total Payments:** The average total payments to all providers for the MS-DRG including the MSDRG amount, teaching, disproportionate share, capital, and outlier payments for all cases.
* **Average Medicare Payments:** The average amount that Medicare pays to the provider for Medicare's share of the MS-DRG. Average Medicare payment amounts include the MS-DRG amount, teaching, disproportionate share, capital, and outlier payments for all cases.
* **Body System:** The human body system which is impacted with respect to the DRG.
* **Medical Department:** the Medical Department responsible for the DRG

## Overview Datasets

In addition to the parent dataset, we created overview datasets to give a concise overview about the following statistics for each DRG, medical department, and human body system: 
  
* Total Discharges 
* Average Medicare Payments
* Average Covered Charges 
* Average Total Payments 

In addition to these overview datasets, we created datasets for the top 5, 10, 20, 50 and 100 DRGs for each statistic. 

[Download Overview Datasets](https://drive.google.com/drive/folders/1jFGiPVSD6bUyfyUvHMoYUWjG5qbjXl9V?usp=sharing)

--------------------------------------------------------
  
# Overview of Medicare Beneficiaries for 2011 - 2015
  
## Total Discharge Statistics
From looking at the bar chart below, we can see that **“Major joint replacement of lower extremity w/o MCC” had the most discharges from 2011-15**, with a total of **2224929 discharges**. This may be due to the fact that “hip, knee and other joint replacement procedures are among the most common elective surgeries in the United States”. In fact, the ages of people undergoing joint replacement surgeries has been slowly decreasing. Reasons for this may include the increasing rates of obesity in the United States. However it may also be due to the fact that more people are staying active as they move into old age. The level of activity that is desirable for older adults these days may be putting extra pressure on their joints, causing them to need joint replacement surgeries. 

Not far behind in the DRGs with the most discharges is **“Septicemia or severe sepsis w/o MV 96+ hours w/ MCC”**. Sepsis is a life threatening condition where *“chemicals released into the bloodstream to fight the infection trigger inflammatory responses throughout the body”*. Sepsis is caused by infections, which are quite common. Weak immune systems can make people more prone to sepsis and older people - including the ones who qualify for Medicare - often have weaker immune systems.
```{r Part Two:Total Discharge Statistics, results = 'asis', echo=FALSE, message=FALSE, warning=FALSE}

##############################################################################################
# Discharge Data                                                                             #
##############################################################################################

top_10_discharges <- read.csv("../../Data/Prepared/top_10_discharges.csv") 
top_10_discharges <- top_10_discharges %>% arrange(total_discharges)
colnames(top_10_discharges) <- c("drg","2011", "2012", "2013", "2014", "2015", "total")
f <- list( family = "Open Sans, Sans Serif, monospace", size = 10, color = "#7f7f7f")

##############################################################################################
# Discharge Bar Chart Viz                                                                    #
##############################################################################################

# Horizontal Bar Chart

y <- list( title = "", titlefont = f)
x <- list( title = "Number of Discharges", titlefont = f)
t <- list(
family = "Arial",
size = 9,
color = 'Black')


discharges_h_bar <- plot_ly(top_10_discharges,
x = ~`2011`,
y = ~reorder(drg,total), 
type = 'bar', 
orientation = 'h',
name = '2011', marker = list(color = '#25CCF7')) %>% 
add_trace(x = ~`2012`, name = "2012", marker = list(color = '#1B9CFC')) %>%
  add_trace(x = ~`2013`, name = "2013", marker = list(color = '#B33771')) %>% 
  add_trace(x = ~`2014`, name = "2014", marker = list(color = '#3B3B98')) %>% 
  add_trace(x = ~`2015`, name = "2015", marker = list(color = '#182C61')) %>%
  layout(title = 'DRGs with Most Discharges for 2011-15 (Top 10)',
         font = t,
         xaxis = x, 
         yaxis = y,
         barmode = 'stack',
         margin = list(l = 420, b = 100, pad = 4), 
         yaxis = list(tickangle = 90),
         legend = list(title = 'Legend',
                       font = list( family = "sans-serif",
                                    size = 8,
                                    color = "#000"),
                       bgcolor = "FFFFFF",
                       bordercolor = "#0a3d62",
                       borderwidth = 0.5)) %>%
  add_annotations(xref = 'x1', yref = 'y',
                  x = ~total + 160000,
                  text =  ~paste(total, '<br>discharges'),
                  font = list(family = 'Arial', size = 10, color = 'rgb(10, 10, 10)'),
                  showarrow = FALSE)    

##############################################################################################
# Top 10 DRG Discharges Cost Break Down Bar Chart                                            #
##############################################################################################
cost_breakdown <- read.csv("../../Data/Prepared/top_10_discharge_costs.csv")
cost_breakdown <- cost_breakdown %>% arrange(-discharges)

t <- list(
  family = "sans-serif",
  size = 10,
  color = 'Black')

cost_breakdown_chart <- plot_ly(cost_breakdown, 
                                y = ~reorder(drg, discharges), 
                                x = ~avg_covered_charge, 
                                type = 'bar', 
                                name = 'Average Covered Charges', 
                                marker = list(color = '#31A4DB'),
                                orientation = "h") %>%
  add_trace(x = ~avg_total_payment, name = 'Average Total Payments', marker = list(color = '#9EC43C')) %>%
  add_trace(x = ~avg_medicare_payment, name = 'Average Medicare Charges', marker = list(color = 'F6AB3B')) %>% 
  layout(title = "Cost Breakdown for the DRGs with Most Discharges - Top 10",
         font = t, 
         xaxis = list(title = 'Cost ($)'),
         yaxis = list(title = ''), 
         barmode = 'group', margin = list(l = 420,t = 50, pad = 4), 
         xaxis = list(tickangle = 45),
         legend = list(title = 'Legend',
                       font = list( family = "sans-serif",
                                    size = 10,
                                    color = "#000"),
                       bgcolor = "FFFFFF",
                       bordercolor = "#0a3d62",
                       borderwidth = 0.5)) 

##############################################################################################
# Discharge Statistics for Human Body System Affected                                        #
##############################################################################################

# need to add in data visualization 

##############################################################################################
# Discharge Table                                                                            #
##############################################################################################
# Renaming columns for better presentation of the table
colnames(top_10_discharges) <- c("DRG","2011", "2012", "2013", "2014", "2015", "Total Discharges")
#Transposing the dataframe for better presenation of the data in the HTML document
#Commenting out for the time being
#kable(top_10_discharges, digits = 2,  caption = "Top 10 Diagnostic Related Groups with the Most Discharges (2011-15)")
```

---------------------------------------------------------------------------------------------------------------------------------------------------

`r discharges_h_bar`

---------------------------------------------------------------------------------------------------------------------------------------------------
In addition to having the most discharges, **“Major joint replacement of lower extremity w/o MCC” also has the most average covered charges, average total payments, and average medicare charges.** The costs of joint replacements vary by the type of implant, the surgical approach, preexisting conditions, time spent on the operating table, time spent in the hospital, and any complications that arise. Seeing as patients often have to spend quite a bit of time in the hospital for these procedures and the implants themselves are quite expensive, it makes sense that this DRG has the most average covered charges, average total payments, and average medicare charges. 

The second DRG with the most discharges also happens to have the second highest amount in average covered charges. **This DRG is “Septicemia or severe sepsis w/o MV 96+ hours w/ MCC”**. Sepsis is a life threatening condition where “chemicals released into the bloodstream to fight the infection trigger inflammatory responses throughout the body”. These inflammatory responses can damage organ systems and cause organ failure, often leading to death. Patients with severe sepsis often have damage to multiple organ systems, and treating numerous organ systems is quite expensive. 

Finally, the **fifth DRG with the most discharges, “Heart failure & shock w/ MCC” has the third highest amount in average covered charges, average total payments, and average medicare charges**. Heart failure occurs when your heart is not pumping blood efficiently. A patient can die if their heart becomes too weak or stiff to pump blood. In order to trigger the heart to pump at a more normal rhythm, their hearts need to be shocked. If complications arise, the procedure can become even more costly.
---------------------------------------------------------------------------------------------------------------------------------------------------

`r cost_breakdown_chart `

## Total Discharges for All States of USA
In looking at the number of discharges by state, we can clearly see that Florida, Texas, California, and New York have the most number of discharges. Seeing as these states also have the highest populations, it is no surprise that they have the most number of discharges.

```{r Part One and Two Chloropleths, results = 'asis', echo=FALSE, message=FALSE, warning=FALSE}
drg_state_avg_covered_charges <- read.csv("../../Data/Prepared/drg_state_avg_covered_charges.csv")
g <- list(scope = 'usa',
  projection = list(type = 'albers usa'),
  showlakes = TRUE,
  lakecolor = toRGB('white'))

avg_covered_charges_plot <- plot_geo(drg_state_avg_covered_charges, locationmode = 'USA-states') %>%
  add_trace(
    z = ~avg_covered_charges, locations = ~state,
    color = ~avg_covered_charges, colors = 'Blues'
  ) %>%
  colorbar(title = "Average Covered Charges") %>%
  layout(
    title = 'Average Covered Charges by State',
    geo = g
  )

total_discharges_plot <- plot_geo(drg_state_avg_covered_charges, locationmode = 'USA-states') %>%
  add_trace(
    z = ~total_discharges, locations = ~state,
    color = ~total_discharges, colors = 'Blues'
  ) %>%
  colorbar(title = "Total Discharges") %>%
  layout(
    title = 'Total Discharges by State',
    geo = g
  )
```

`r total_discharges_plot`

## Average Medicare Payment Statistics

```{r Part Three: Average Medicare Payment Statistics, results = 'asis', echo=FALSE, message=FALSE, warning=FALSE}

##############################################################################################
# Data - Medicare Overview
##############################################################################################

f <- list( family = "Open Sans, Sans Serif, monospace", size = 10, color = "#7f7f7f")
top_10_medicare <- read.csv("../../Data/Prepared/top_10_avg_medicare_payments.csv")
top_10_medicare <- top_10_medicare%>% arrange(avg_medicare_payments)
colnames(top_10_medicare) <- c("drg","2011", "2012", "2013", "2014", "2015", "avg")

# Vertical Bar Chart
x <- list( title = "Average Medicare Payments($)", titlefont = f)
y <- list( title = "", titlefont = f)

medicare_payments_bar <- plot_ly(top_10_medicare,
y = ~reorder(drg, avg),
x = ~`avg` , 
type = 'bar', 
name = 'Average Medicare Payments', 
orientation = "h",
marker = list(color = '#F6AB3B')) %>% 
layout(title = 'Top 10 DRGs with Highest Average Medicare Payments',
       xaxis = x, 
       yaxis = y,
       font = t,
       margin = list( l = 430, pad = 4), 
       xaxis = list(tickangle = 45)) %>%
  add_annotations(xref = 'x1', yref = 'y',
                  x = ~avg + 5500,
                  text = ~paste("$",round(avg,2)),
                  font = list(family = 'Arial', size = 10, color = 'rgb(10, 10, 10)'),
                  showarrow = FALSE)                  
```
---------------------------------------------------------------------------------------------------------------------------------------------------

`r medicare_payments_bar`

**Did you Know?:**
> Heart transplants and heart assist system implants are quite expensive, but if patients under Medicare meet the medical criteria for these surgeries, Medicare will cover some of the charges. Because these heart transplants are so expensive - they can be over a million dollars - it makes sense that the top DRG with the highest average Medicare payments is “heart transplant or implant of heart assist system w/ MCC”. While these procedures have a whopping $85370.33 average, the next DRG with the highest average Medicare payment is “ECMO or trach w/ > 96 hrs or PDX EXC face, mouth & neck w/ MAJ O.R.” at $48640.82. Systems like ECMO cost quite a bit as they provide patients with “cardiac and respiratory support” to keep them alive. This type of machinery, when going on for long periods of time, racks up large bills.

## Average Covered Charge Statistics
```{r Part Four: Average Covered Charge Statistics, results = 'asis', echo=FALSE, message=FALSE, warning=FALSE}

##############################################################################################
# Data
##############################################################################################

f <- list( family = "Open Sans, Sans Serif, monospace", size = 10, color = "#7f7f7f")
top_10_covered <- read.csv("../../Data/Prepared/top_10_avg_covered_charges.csv")
top_10_covered <- top_10_covered%>% arrange(avg_covered_charges)
colnames(top_10_covered) <- c("drg","2011", "2012", "2013", "2014", "2015", "avg")


# Horizontal Bar Chart

y <- list( title = "", titlefont = f)
x <- list( title = "Average Covered Charges($)", titlefont = f)

covered_charges_h_bar <- plot_ly(top_10_covered,
y = ~reorder(drg, avg),
x = ~`avg` , 
type = 'bar', 
name = 'Average Covered Charges',
orientation = "h",
marker = list(color = '#31A4DB')) %>% 
layout(title = 'Top 10 DRGs with Highest Average Covered Charges',
       xaxis = x, 
       yaxis = y,
       font = t,
       margin = list( l = 430, pad = 4),
       xaxis = list(tickangle = 45)) %>%
  add_annotations(xref = 'x1', yref = 'y',
                  x = ~avg + 28000,
                  text = ~paste("$",round(avg,2)),
                  font = list(family = 'Arial', size = 10, color = 'rgb(10, 10, 10)'),
                  showarrow = FALSE)   
```

`r covered_charges_h_bar`


# Average Total Payment Statistics
```{r Part Five: Average Total Payment Statistics, results = 'asis', echo=FALSE, message=FALSE, warning=FALSE}

##############################################################################################
# Data - Average Total Payments                                                              #
##############################################################################################
f <- list( family = "Open Sans, Sans Serif, monospace", size = 10, color = "#7f7f7f")
top_10_payments <- read.csv("../../Data/Prepared/top_10_avg_total_payments.csv")
top_10_payments <- top_10_payments%>% arrange(avg_total_payments)
colnames(top_10_payments) <- c("drg","2011", "2012", "2013", "2014", "2015", "avg")

##############################################################################################
# Bar Chart Viz for Average Total Payment Statistics
# Horizontal Bar Chart
y <- list( title = "", titlefont = f)
x <- list( title = "Average Total Payments ($)", titlefont = f)
total_payments_h_bar <- plot_ly(top_10_payments,
y = ~reorder(drg, avg),
x = ~`avg` , 
type = 'bar', 
name = 'Average Total Payments',
orientation = "h",
marker = list(color = '#9EC43C')) %>% 
layout(title = 'Top 10 DRGs with Highest Average Total Payments',
       xaxis = x, 
       yaxis = y,
       font = t,
       margin = list( l = 430, pad = 4),
       margin = list(l = 500, pad = 4), 
       xaxis = list(tickangle = 45)) %>%
  add_annotations(xref = 'x1', yref = 'y',
                  x = ~avg + 8000,
                  text = ~paste("$",round(avg,2)),
                  font = list(family = 'Arial', size = 10, color = 'rgb(10, 10, 10)'),
                  showarrow = FALSE) 


```

`r total_payments_h_bar`
`r avg_covered_charges_plot` 

# Analyzing USA's Health Providers for the Year 2015
Within the top 10 providers with the highest average total payments in 2015, Midwestern Region Medical Center and Walnut Hill Medical Center stand out as their average medicare payment is significantly lower than the rest. Upon further research, Midwestern Region Medical Center is primarily a cancer treatment center. Cancer is one of the most expensive conditions to treat, leaving patients with thousands of dollars to be paid from out-of-pocket. “Cancer patients with only Medicare coverage face steep out-of-pocket costs,” “without additional health coverage paid an average of $8,115 a year, “ according to a study done by John Hopkins University. With the other providers, the difference between the total payments and medicare payments is similar. As a cancer treatment hospital, the total charges from the hospital is steep, but the coverage by Medicare is significantly lower, requiring patients to pay out-of-pocket for their treatment.


```{r Part Six: Analyzing USA Health Providers, results = 'asis', echo=FALSE, message=FALSE, warning=FALSE}

highest.2015 <- read.csv("../../Data/Prepared/provider_2015_plot_data_highest.csv")

plot.2015.highest <- plot_ly(highest.2015, x = ~reorder(Provider.Name, -avg_total_payments), y= ~avg_total_payments, type="bar", marker = list(color = 'dodgerblue'), name = "Average Total Payments") %>% 
  add_trace(y = ~avg_medicare_payments, name = "Average Medicare Payments", marker = list(color = 'lightgreen')) %>% 
  layout(title = "Top 10 Providers with Highest Average Total Payments in 2015", 
         xaxis = list(title = 'Provider'),
         yaxis = list(title = 'Average Total Payments ($)'),
         barmode = "Group", margin = list(b = 160, t = 50))


lowest.2015 <- read.csv("../../Data/Prepared/provider_2015_plot_data_lowest.csv")

plot.2015.lowest <- plot_ly(lowest.2015, x = ~reorder(Provider.Name, avg_total_payments), y= ~avg_total_payments, type="bar", marker = list(color = 'skyblue'), name = "Average Total Payments") %>% 
        add_trace(y = ~avg_medicare_payments, name = "Average Medicare Payments", marker = list(color = 'blue')) %>% 
        layout(title = "Top 10 Providers with Lowest Average Total Payments in 2015", 
          xaxis = list(title = 'Provider'),
          yaxis = list(title = 'Average Total Payments ($)'),
          barmode = "Group", margin = list(b = 160, t = 50))

```

`r plot.2015.highest`

`r plot.2015.lowest`

# Analyzing Cost Change with Time
```{r Part IDK: Analyzing Cost Change with Time, results = 'asis', echo=FALSE, message=FALSE, warning=FALSE}

drg_year_breakdown_top100 <- read.csv("../../Data/Prepared/year_cost_breakdown_100.csv")

discharge_top100_medicare <- drg_year_breakdown_top100 %>% plot_ly(x = ~avg_covered_charge, 
                                                                    y = ~avg_medicare_payment, 
                                                                    color = ~medical_department, 
                                                                    frame = ~year, 
                                                                    text = ~drg, 
                                                                    hoverinfo = "text",
                                                                    type = 'scatter',
                                                                    mode = 'markers') %>% 
                                                                    layout(title = 'Average Medicare Payments Changing with Time for DRGS with Highest Discharges (top 100)',
                                                                    xaxis = list(type = "log", title="Average Covered Charges($)"), 
                                                                    yaxis =list(title="Average Medicare Payments($)")) %>% 
                                                                    animation_opts(1000, easing = "elastic", redraw = FALSE)
```

`r discharge_top100_medicare`


# Works Cited

* https://www.cnn.com/2018/03/06/health/hip-knee-replacement-surgeries-earlier-study/index.html
* https://medicare.com/coverage/does-medicare-cover-hip-replacements/
* https://medicare.com/coverage/does-medicare-cover-knee-replacement-surgery/
* https://www.healthline.com/health/total-knee-replacement-surgery/understanding-costs
* https://medicare.com/coverage/does-medicare-cover-a-heart-transplant/
* https://en.wikipedia.org/wiki/Extracorporeal_membrane_oxygenation
* https://www.mayoclinic.org/diseases-conditions/sepsis/symptoms-causes/syc-20351214
* https://www.medicare.gov/Pubs/pdf/11931-Cancer-Treatment-Services.pdf
* https://medigapseminars.org/the-cost-of-cancer-treatment-with-medicare/
*https://www.washingtonpost.com/news/to-your-health/wp/2016/11/23/many-medicare-cancer-patients-hit-by-high-out-of-pocket-costs/?noredirect=on&utm_term=.71bcc9bc21b9